import{_ as a,o as s,c as e,N as n}from"./chunks/framework.727b779d.js";const u=JSON.parse('{"title":"PVE到ESXi的虚拟机迁移操作","description":"","frontmatter":{},"headers":[],"relativePath":"virtualization/pve-虚拟机迁移-pve2esxi.md"}'),l={name:"virtualization/pve-虚拟机迁移-pve2esxi.md"},t=n(`<h1 id="pve到esxi的虚拟机迁移操作" tabindex="-1">PVE到ESXi的虚拟机迁移操作 <a class="header-anchor" href="#pve到esxi的虚拟机迁移操作" aria-label="Permalink to &quot;PVE到ESXi的虚拟机迁移操作&quot;">​</a></h1><h2 id="迁移前注意事项" tabindex="-1">迁移前注意事项 <a class="header-anchor" href="#迁移前注意事项" aria-label="Permalink to &quot;迁移前注意事项&quot;">​</a></h2><blockquote><p>确保导出的位置有足够空间，我这里显示的/mnt/pve/data 还有2.2T，所以后续导出的目录都在/mnt/pve/data下</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161023433.PNG" alt=""></p><h2 id="pve-中进行" tabindex="-1">PVE 中进行 <a class="header-anchor" href="#pve-中进行" aria-label="Permalink to &quot;PVE 中进行&quot;">​</a></h2><h3 id="ssh到pve主机-进行backup" tabindex="-1">SSH到PVE主机，进行Backup <a class="header-anchor" href="#ssh到pve主机-进行backup" aria-label="Permalink to &quot;SSH到PVE主机，进行Backup&quot;">​</a></h3><blockquote><p>ssh root@PVE_HOST_IP</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">vzdump &lt;VMID1&gt; &lt;VMID2&gt; --dumpdir /mnt/pve/data/dump/ --compress zstd</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><blockquote><p>说明: - 以上的命令会在 /mnt/pve/data/dump/ 目录中以zstd压缩格式备份 &lt;VMID1&gt; &lt;VMID2&gt; 号虚拟机</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161033343.PNG" alt=""></p><h3 id="备份完成后" tabindex="-1">备份完成后 <a class="header-anchor" href="#备份完成后" aria-label="Permalink to &quot;备份完成后&quot;">​</a></h3><blockquote><p>PVE内置的备份可以生成 VMA文件 (Proxmox Virtual Machine Archive)备份在目录/var/lib/vz/images下,PVE的web端并没有提供下载,可以ssh进入PVE进行导出操作备份后的文件,可以通过vma命令转换成raw.如果你备份时候选择了压缩,请先使用zstd解压</p></blockquote><h3 id="解压备份出来的文件" tabindex="-1">解压备份出来的文件 <a class="header-anchor" href="#解压备份出来的文件" aria-label="Permalink to &quot;解压备份出来的文件&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">cd /mnt/pve/data/dump </span></span>
<span class="line"><span style="color:#babed8;">zstd -d vzdump-qemu-112-2024_02_07-14_56_33.vma.zst</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161037586.PNG" alt=""></p><h3 id="通过vma命令转换成raw后缀的磁盘文件" tabindex="-1">通过vma命令转换成raw后缀的磁盘文件 <a class="header-anchor" href="#通过vma命令转换成raw后缀的磁盘文件" aria-label="Permalink to &quot;通过vma命令转换成raw后缀的磁盘文件&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">vma extract vzdump-qemu-112-2024_02_07-15_09_28.vma extract</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161038238.PNG" alt=""></p><h3 id="用qemu-img把raw转换vmdk-如果有多块磁盘得分别执行" tabindex="-1">用qemu-img把raw转换vmdk，如果有多块磁盘得分别执行. <a class="header-anchor" href="#用qemu-img把raw转换vmdk-如果有多块磁盘得分别执行" aria-label="Permalink to &quot;用qemu-img把raw转换vmdk，如果有多块磁盘得分别执行.&quot;">​</a></h3><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">cd extract/</span></span>
<span class="line"><span style="color:#babed8;">qemu-img convert -f raw -O vmdk disk-drive-scsi0.raw disk-drive-scsi0.vmdk</span></span>
<span class="line"><span style="color:#babed8;">qemu-img convert -f raw -O vmdk disk-drive-scsi1.raw disk-drive-scsi1.vmdk</span></span>
<span class="line"><span style="color:#babed8;">qemu-img convert -f raw -O vmdk disk-drive-scsi2.raw disk-drive-scsi2.vmdk</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161040936.PNG" alt=""></p><h3 id="把转换后的vmdk文件上传到esxi服务器上" tabindex="-1">把转换后的vmdk文件上传到ESXI服务器上 <a class="header-anchor" href="#把转换后的vmdk文件上传到esxi服务器上" aria-label="Permalink to &quot;把转换后的vmdk文件上传到ESXI服务器上&quot;">​</a></h3><blockquote><p>通过web页面或SCP 将文件传输到ESXI服务器上，这里建议用SCP，比较稳定</p></blockquote><h2 id="esxi-中进行" tabindex="-1">ESXI 中进行 <a class="header-anchor" href="#esxi-中进行" aria-label="Permalink to &quot;ESXI 中进行&quot;">​</a></h2><h3 id="进入esxi服务器中-再进行一次磁盘转换" tabindex="-1">进入ESXI服务器中，再进行一次磁盘转换 <a class="header-anchor" href="#进入esxi服务器中-再进行一次磁盘转换" aria-label="Permalink to &quot;进入ESXI服务器中，再进行一次磁盘转换&quot;">​</a></h3><blockquote><p>ssh到ESXi服务器上<br> ssh root@ESXi_HOST_IP<br> 找到上传的vmdk文件存放位置（网页端可以看到datastore的位置 /vmfs/volumes/649930cc-b54f8e72-287b-c81f66b8a8f0）</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">cd /vmfs/volumes/649930cc-b54f8e72-287b-c81f66b8a8f0/pve </span></span>
<span class="line"><span style="color:#babed8;">vmkfstools -i disk-drive-scsi0.vmdk an11-scsi0.vmdk -d thin</span></span>
<span class="line"><span style="color:#babed8;">vmkfstools -i disk-drive-scsi1.vmdk an11-scsi1.vmdk -d thin</span></span>
<span class="line"><span style="color:#babed8;">vmkfstools -i disk-drive-scsi2.vmdk an11-scsi2.vmdk -d thin</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><blockquote><p>说明: 【 -i 】作用是转换，【 -d thin 】作用是将新磁盘文件使用“精简置备模式”。</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161043722.png" alt=""></p><h3 id="转换完成之后-再在esxi-服务器上新建虚拟机-最后一步的时候-把默认磁盘删掉-添加上传上去的磁盘文件作为虚拟机的磁盘即可。" tabindex="-1">转换完成之后，再在ESXi 服务器上新建虚拟机，最后一步的时候，把默认磁盘删掉，添加上传上去的磁盘文件作为虚拟机的磁盘即可。 <a class="header-anchor" href="#转换完成之后-再在esxi-服务器上新建虚拟机-最后一步的时候-把默认磁盘删掉-添加上传上去的磁盘文件作为虚拟机的磁盘即可。" aria-label="Permalink to &quot;转换完成之后，再在ESXi 服务器上新建虚拟机，最后一步的时候，把默认磁盘删掉，添加上传上去的磁盘文件作为虚拟机的磁盘即可。&quot;">​</a></h3><blockquote><p>创建虚拟机、设置自定义设置时，选择适合的配置，将原有的磁盘删除，添加“现有硬盘”，依次添加转为精简置备的多块盘</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161044322.png" alt=""></p><h3 id="启动虚拟机" tabindex="-1">启动虚拟机 <a class="header-anchor" href="#启动虚拟机" aria-label="Permalink to &quot;启动虚拟机&quot;">​</a></h3><blockquote><p>此时如果直接进入系统的话，会因为硬盘驱动的原因报错，解决方法是启动虚拟机后，立即到终端上立刻按下键，选择救援模式进入</p></blockquote><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161045272.png" alt=""></p><blockquote><p>通过账号密码进入系统</p></blockquote><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;"># 新增内核模块，支持vmware硬件</span></span>
<span class="line"><span style="color:#babed8;">vim /etc/dracut.conf.d/drivers.conf</span></span>
<span class="line"><span style="color:#babed8;">add_drivers+=&quot;vmxnet3 vmw_pvscsi&quot;</span></span>
<span class="line"><span style="color:#babed8;"></span></span>
<span class="line"><span style="color:#babed8;"># 使用dracut命令重新构建kernel</span></span>
<span class="line"><span style="color:#babed8;">dracut --verbose --force</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><h2 id="常见问题" tabindex="-1">常见问题 <a class="header-anchor" href="#常见问题" aria-label="Permalink to &quot;常见问题&quot;">​</a></h2><h3 id="网络问题" tabindex="-1">网络问题 <a class="header-anchor" href="#网络问题" aria-label="Permalink to &quot;网络问题&quot;">​</a></h3><ul><li>pve迁移过来的虚拟机都带有 cloud-init ，在重启时它会修改网卡配置，所以我们将它卸载掉</li></ul><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;">rpm -e --nodeps cloud-init</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div><ul><li>在vcenter上查到新虚拟机的mac地址，将虚拟机中网络配置文件的mac地址替换，例如centos7的配置文件为/etc/sysconfig/network-scripts/ifcfg-eth0</li><li>修改之后重启服务器,选择与之匹配的内核启动即可</li></ul><p><img src="https://cdn.jsdelivr.net/gh/callac/markdown-image@main/img/202402161052332.png" alt=""></p><div class="language-"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki material-theme-palenight"><code><span class="line"><span style="color:#babed8;"># centos 修改默认启动内核</span></span>
<span class="line"><span style="color:#babed8;"># 查看当前系统中可用的内核列表</span></span>
<span class="line"><span style="color:#babed8;">awk -F\\&#39; &#39;$1==&quot;menuentry &quot; {print i++ &quot; : &quot; $2}&#39; /etc/grub2.cfg</span></span>
<span class="line"><span style="color:#babed8;"></span></span>
<span class="line"><span style="color:#babed8;"># 使用 grub2-set-default 命令来设置默认启动的内核。例如，如果你想要启动列表中的第1项，可以执行：</span></span>
<span class="line"><span style="color:#babed8;">grub2-set-default 1</span></span>
<span class="line"><span style="color:#babed8;"></span></span>
<span class="line"><span style="color:#babed8;"># 生成新的GRUB配置文件以应用更改：</span></span>
<span class="line"><span style="color:#babed8;">grub2-mkconfig -o /boot/grub2/grub.cfg</span></span>
<span class="line"><span style="color:#babed8;"></span></span>
<span class="line"><span style="color:#babed8;"># 重启系统以使更改生效。</span></span>
<span class="line"><span style="color:#babed8;">reboot</span></span>
<span class="line"><span style="color:#babed8;"></span></span></code></pre></div>`,44),i=[t];function o(p,c,r,d,b,m){return s(),e("div",null,i)}const v=a(l,[["render",o]]);export{u as __pageData,v as default};
